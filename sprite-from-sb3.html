<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>sb3ファイルからスプライトを抽出 - Scratcher向けの便利ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
      }
      #output {
        display: none;
      }
      label, input[type='checkbox'] {
        cursor: pointer;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <h1>sb3ファイルからスプライトを抽出</h1>
    <p>sb3ファイルから、簡単にsprite3ファイルを抽出できます。<br>
    sb, sb2には非対応です。<br>
    sb3ファイルからスプライトを抽出する以外の処理は一切行っておりません。</p>
    <input type="file" id="sb3Input" accept=".sb3" /><br>
    <div id="spriteSelector"></div>
    <pre id="output" style="white-space: pre-wrap; max-height: 400px; overflow: auto;"></pre>
    <a href="./">トップページに戻る</a>
    <script>
      const sb3Input = document.getElementById("sb3Input");
      const spriteSelector = document.getElementById("spriteSelector");
      const output = document.getElementById("output");
      sb3Input.value = "";
      sb3Input.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) return;

        JSZip.loadAsync(file).then(function (zip) {
          if (!zip.files["project.json"]) {
            alert("project.jsonが見つからないじゃない！？sb3ファイル以外なんかよこさないでよっ！");
            return;
          }

          zip.files["project.json"].async("string").then(function (jsonStr) {
            try {
              const json = JSON.parse(jsonStr);
              spriteSelector.childNodes.forEach(element => element.remove()); // 既存の選択肢をクリア
              json.targets.forEach((element, index) => {
                const spriteSelectorElement = document.createElement("div");
                spriteSelectorElement.innerHTML = `<label><input type="radio" name="spriteSelector" data-index=${index}>${element.name}${element.isStage ? " (非推奨)" : ""}</label>`;
                spriteSelector.append(spriteSelectorElement);
              });
              output.textContent = JSON.stringify(json, null, 2);
            }catch(err){
              output.textContent = "JSONの解析に失敗しました。";
            }
          });
        }).catch(function (err){
          output.textContent = "ZIP展開に失敗しました: " + err.message;
        });
      });
    </script>
  </body>
</html>